<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Squid Game - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="./js/api-service.js"></script>
    <script src="./js/game-state-manager.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Gugi&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Gugi", sans-serif;
        background: linear-gradient(
          135deg,
          #1a1a2e 0%,
          #16213e 50%,
          #0f3460 100%
        );
      }
      .card-bg {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .status-online {
        background: linear-gradient(90deg, #10b981 0%, #059669 100%);
      }
      .status-offline {
        background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
      }
      .refresh-btn {
        transition: transform 0.2s ease;
      }
      .refresh-btn:hover {
        transform: rotate(180deg);
      }
    </style>
  </head>
  <body class="min-h-screen text-white">
    <div class="container mx-auto px-4 py-8">
      <!-- Header -->
      <div class="flex justify-between items-center mb-8">
        <h1
          class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-purple-600"
        >
          ðŸŽ® Squid Game Admin
        </h1>
        <div class="flex items-center gap-4">
          <button
            id="refresh-btn"
            class="refresh-btn bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg"
          >
            ðŸ”„ Refresh
          </button>
          <div
            id="connection-status"
            class="px-4 py-2 rounded-full text-sm font-semibold"
          >
            ðŸ”„ Checking...
          </div>
        </div>
      </div>

      <!-- Live Statistics -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="card-bg rounded-xl p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-300 text-sm">Active Sessions</p>
              <p id="active-sessions" class="text-2xl font-bold text-green-400">
                0
              </p>
            </div>
            <div class="text-3xl">ðŸ‘¥</div>
          </div>
        </div>

        <div class="card-bg rounded-xl p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-300 text-sm">Total Players</p>
              <p id="total-players" class="text-2xl font-bold text-blue-400">
                0
              </p>
            </div>
            <div class="text-3xl">ðŸŽ¯</div>
          </div>
        </div>

        <div class="card-bg rounded-xl p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-300 text-sm">Total Coins</p>
              <p id="total-coins" class="text-2xl font-bold text-yellow-400">
                0
              </p>
            </div>
            <div class="text-3xl">ðŸ’°</div>
          </div>
        </div>

        <div class="card-bg rounded-xl p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-300 text-sm">Total Taps</p>
              <p id="total-taps" class="text-2xl font-bold text-pink-400">0</p>
            </div>
            <div class="text-3xl">ðŸ‘†</div>
          </div>
        </div>
      </div>

      <!-- Charts Section -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="card-bg rounded-xl p-6">
          <h3 class="text-xl font-semibold mb-4">Player Activity (Last 24h)</h3>
          <canvas id="activity-chart" width="400" height="200"></canvas>
        </div>

        <div class="card-bg rounded-xl p-6">
          <h3 class="text-xl font-semibold mb-4">Level Distribution</h3>
          <canvas id="level-chart" width="400" height="200"></canvas>
        </div>
      </div>

      <!-- Game State Details -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="card-bg rounded-xl p-6">
          <h3 class="text-xl font-semibold mb-4">Current Game State</h3>
          <div id="game-state-details" class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-300">Level:</span>
              <span id="current-level" class="text-white">-</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-300">HP:</span>
              <span id="current-hp" class="text-white">-</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-300">Coins:</span>
              <span id="current-coins" class="text-white">-</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-300">Coin Earn:</span>
              <span id="current-coin-earn" class="text-white">-</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-300">Auto Earn:</span>
              <span id="auto-earn-status" class="text-white">-</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-300">Last Recovery:</span>
              <span id="last-recovery" class="text-white">-</span>
            </div>
          </div>
        </div>

        <div class="card-bg rounded-xl p-6">
          <h3 class="text-xl font-semibold mb-4">System Status</h3>
          <div id="system-status" class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-300">Server Connection:</span>
              <span id="server-status" class="text-white">-</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-300">Authentication:</span>
              <span id="auth-status" class="text-white">-</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-300">Sync Status:</span>
              <span id="sync-status" class="text-white">-</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-300">Pending Changes:</span>
              <span id="pending-changes" class="text-white">-</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-300">Last Sync:</span>
              <span id="last-sync" class="text-white">-</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="card-bg rounded-xl p-6">
        <h3 class="text-xl font-semibold mb-4">Recent Activity</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-gray-600">
                <th class="text-left py-2">Time</th>
                <th class="text-left py-2">Action</th>
                <th class="text-left py-2">Details</th>
                <th class="text-left py-2">Result</th>
              </tr>
            </thead>
            <tbody id="activity-log">
              <tr>
                <td colspan="4" class="text-center py-4 text-gray-400">
                  Loading activity...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Debug Console -->
      <div class="card-bg rounded-xl p-6 mt-6">
        <h3 class="text-xl font-semibold mb-4">Debug Console</h3>
        <div
          id="debug-console"
          class="bg-black rounded-lg p-4 h-64 overflow-y-auto font-mono text-xs"
        >
          <div class="text-green-400">Admin Dashboard initialized...</div>
        </div>
      </div>
    </div>

    <script>
      // Admin Dashboard JavaScript
      let activityChart = null;
      let levelChart = null;
      let activityLog = [];

      // Debug logging
      function debugLog(message) {
        const console = document.getElementById("debug-console");
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement("div");
        logEntry.className = "text-green-400";
        logEntry.textContent = `[${timestamp}] ${message}`;
        console.appendChild(logEntry);
        console.scrollTop = console.scrollHeight;

        // Keep only last 100 entries
        while (console.children.length > 100) {
          console.removeChild(console.firstChild);
        }
      }

      // Load game state from localStorage
      function loadGameState() {
        try {
          const saved = localStorage.getItem("squidGameState");
          if (saved) {
            return JSON.parse(saved);
          }
        } catch (error) {
          debugLog("Error loading game state: " + error.message);
        }
        return null;
      }

      // Load activity log from localStorage
      function loadActivityLog() {
        try {
          const saved = localStorage.getItem("squidGameActivityLog");
          if (saved) {
            return JSON.parse(saved);
          }
        } catch (error) {
          debugLog("Error loading activity log: " + error.message);
        }
        return [];
      }

      // Update connection status
      function updateConnectionStatus() {
        const statusElement = document.getElementById("connection-status");

        // Check if API service is available and connected
        if (window.apiService) {
          const isOnline = navigator.onLine;
          const hasAuth = window.apiService.isAuthenticated();

          if (isOnline && hasAuth) {
            statusElement.textContent = "ðŸŸ¢ Online";
            statusElement.className =
              "status-online px-4 py-2 rounded-full text-sm font-semibold";
          } else if (isOnline) {
            statusElement.textContent = "ðŸŸ¡ Connected (No Auth)";
            statusElement.className =
              "bg-yellow-600 px-4 py-2 rounded-full text-sm font-semibold";
          } else {
            statusElement.textContent = "ðŸ”´ Offline";
            statusElement.className =
              "status-offline px-4 py-2 rounded-full text-sm font-semibold";
          }
        } else {
          statusElement.textContent = "ðŸ”´ Service Unavailable";
          statusElement.className =
            "status-offline px-4 py-2 rounded-full text-sm font-semibold";
        }
      }

      // Update statistics
      function updateStatistics() {
        const gameState = loadGameState();
        const activityLog = loadActivityLog();

        if (gameState) {
          // Update current game state
          document.getElementById("current-level").textContent =
            gameState.level || 1;
          document.getElementById("current-hp").textContent = `${
            gameState.hp || 0
          }/${getLevelHP(gameState.level || 1)}`;
          document.getElementById("current-coins").textContent = (
            gameState.coinCount || 0
          ).toLocaleString();
          document.getElementById("current-coin-earn").textContent = (
            gameState.coinEarn || 0
          ).toLocaleString();
          document.getElementById("auto-earn-status").textContent =
            gameState.autoEarnEnabled ? "Enabled" : "Disabled";

          if (gameState.lastRecover) {
            const lastRecover = new Date(gameState.lastRecover);
            document.getElementById("last-recovery").textContent =
              lastRecover.toLocaleString();
          } else {
            document.getElementById("last-recovery").textContent = "Never";
          }

          // Update totals
          document.getElementById("total-coins").textContent = (
            (gameState.coinCount || 0) + (gameState.coinEarn || 0)
          ).toLocaleString();

          debugLog(
            `Game state updated - Level: ${gameState.level}, HP: ${gameState.hp}, Coins: ${gameState.coinCount}`
          );
        }

        // Update activity statistics
        document.getElementById("total-taps").textContent =
          activityLog.length.toLocaleString();
        document.getElementById("active-sessions").textContent = gameState
          ? "1"
          : "0";
        document.getElementById("total-players").textContent = gameState
          ? "1"
          : "0";

        // Update system status
        if (window.gameStateManager) {
          const syncStatus = window.gameStateManager.getSyncStatus();
          document.getElementById("server-status").textContent =
            syncStatus.isOnline ? "Connected" : "Offline";
          document.getElementById("auth-status").textContent =
            syncStatus.isAuthenticated ? "Authenticated" : "Not Authenticated";
          document.getElementById("sync-status").textContent =
            syncStatus.lastSyncTime ? "Synced" : "Pending";
          document.getElementById("pending-changes").textContent =
            syncStatus.pendingChanges || 0;

          if (syncStatus.lastSyncTime) {
            const lastSync = new Date(syncStatus.lastSyncTime);
            document.getElementById("last-sync").textContent =
              lastSync.toLocaleString();
          } else {
            document.getElementById("last-sync").textContent = "Never";
          }
        }
      }

      // Helper function to get level HP (same as in main game)
      function getLevelHP(level) {
        if (level <= 1) return 100;
        let hp = 100;
        for (let lv = 2; lv <= level; lv++) {
          if (lv <= 30) hp += 50;
          else if (lv <= 60) hp += 100;
          else if (lv <= 90) hp += 150;
          else hp += 200;
        }
        return hp;
      }

      // Update activity log table
      function updateActivityLog() {
        const activityLog = loadActivityLog();
        const tbody = document.getElementById("activity-log");

        if (activityLog.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="4" class="text-center py-4 text-gray-400">No activity recorded</td></tr>';
          return;
        }

        // Show last 10 activities
        const recentActivities = activityLog.slice(-10).reverse();
        tbody.innerHTML = recentActivities
          .map((activity) => {
            const time = new Date(activity.timestamp).toLocaleTimeString();
            return `
                    <tr class="border-b border-gray-700">
                        <td class="py-2">${time}</td>
                        <td class="py-2">${activity.action}</td>
                        <td class="py-2">${activity.details}</td>
                        <td class="py-2 text-green-400">${activity.result}</td>
                    </tr>
                `;
          })
          .join("");
      }

      // Initialize charts
      function initializeCharts() {
        // Activity Chart
        const activityCtx = document
          .getElementById("activity-chart")
          .getContext("2d");
        activityChart = new Chart(activityCtx, {
          type: "line",
          data: {
            labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
            datasets: [
              {
                label: "Taps per Hour",
                data: Array(24).fill(0),
                borderColor: "rgb(59, 130, 246)",
                backgroundColor: "rgba(59, 130, 246, 0.1)",
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                labels: { color: "white" },
              },
            },
            scales: {
              x: {
                ticks: { color: "white" },
                grid: { color: "rgba(255,255,255,0.1)" },
              },
              y: {
                ticks: { color: "white" },
                grid: { color: "rgba(255,255,255,0.1)" },
              },
            },
          },
        });

        // Level Chart
        const levelCtx = document
          .getElementById("level-chart")
          .getContext("2d");
        levelChart = new Chart(levelCtx, {
          type: "doughnut",
          data: {
            labels: ["Level 1-10", "Level 11-30", "Level 31-50", "Level 51+"],
            datasets: [
              {
                data: [1, 0, 0, 0],
                backgroundColor: [
                  "rgba(34, 197, 94, 0.8)",
                  "rgba(59, 130, 246, 0.8)",
                  "rgba(168, 85, 247, 0.8)",
                  "rgba(239, 68, 68, 0.8)",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                labels: { color: "white" },
              },
            },
          },
        });

        debugLog("Charts initialized");
      }

      // Update charts with real data
      function updateCharts() {
        const activityLog = loadActivityLog();
        const gameState = loadGameState();

        // Update activity chart with hourly tap data
        if (activityChart && activityLog.length > 0) {
          const hourlyData = Array(24).fill(0);
          const now = new Date();
          const today = new Date(
            now.getFullYear(),
            now.getMonth(),
            now.getDate()
          );

          activityLog.forEach((activity) => {
            const activityDate = new Date(activity.timestamp);
            if (activityDate >= today) {
              const hour = activityDate.getHours();
              hourlyData[hour]++;
            }
          });

          activityChart.data.datasets[0].data = hourlyData;
          activityChart.update();
        }

        // Update level chart
        if (levelChart && gameState) {
          const level = gameState.level || 1;
          let levelData = [0, 0, 0, 0];

          if (level <= 10) levelData[0] = 1;
          else if (level <= 30) levelData[1] = 1;
          else if (level <= 50) levelData[2] = 1;
          else levelData[3] = 1;

          levelChart.data.datasets[0].data = levelData;
          levelChart.update();
        }
      }

      // Refresh all data
      function refreshData() {
        debugLog("Refreshing dashboard data...");
        updateConnectionStatus();
        updateStatistics();
        updateActivityLog();
        updateCharts();
        debugLog("Dashboard data refreshed");
      }

      // Initialize dashboard
      function initializeDashboard() {
        debugLog("Initializing admin dashboard...");

        // Set up refresh button
        document
          .getElementById("refresh-btn")
          .addEventListener("click", refreshData);

        // Initialize charts
        initializeCharts();

        // Initial data load
        refreshData();

        // Auto-refresh every 30 seconds
        setInterval(refreshData, 30000);

        debugLog("Admin dashboard ready");
      }

      // Start when page loads
      document.addEventListener("DOMContentLoaded", initializeDashboard);

      // Handle online/offline events
      window.addEventListener("online", updateConnectionStatus);
      window.addEventListener("offline", updateConnectionStatus);
    </script>
  </body>
</html>
