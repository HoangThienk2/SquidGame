<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Gugi&display=swap"
      rel="stylesheet"
    />
    <style>
      .gradient-bg {
        background: linear-gradient(
          360deg,
          rgba(211, 47, 181, 0) 3.4%,
          #250a1f 98.64%
        );
      }

      .card-bg {
        background: radial-gradient(
          50% 50% at 50% 50%,
          #450832 0%,
          #2e032c 100%
        );
        border: 1px solid rgba(215, 12, 163, 0.3);
        box-shadow: inset 0px 1px 4px 0px rgba(70, 13, 55, 0.69);
      }

      /* Custom Progress Bar Styles */
      .custom-progress-bg {
        background-color: #2e032c;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.5);
      }

      .custom-progress-fill {
        background: linear-gradient(
          90deg,
          #ff6b8b 0%,
          #ff4081 50%,
          #ff6b8b 100%
        );
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s ease-in-out;
        position: relative;
        box-shadow: 0 0 8px rgba(255, 107, 139, 0.4);
      }

      .custom-progress-fill::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          90deg,
          transparent 0%,
          rgba(255, 255, 255, 0.3) 50%,
          transparent 100%
        );
        animation: shimmer 2s infinite;
      }

      .custom-progress-fill::before {
        content: "";
        position: absolute;
        top: 1px;
        left: 1px;
        right: 1px;
        height: 40%;
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.4) 0%,
          rgba(255, 255, 255, 0.1) 100%
        );
        border-radius: 3px;
      }

      @keyframes shimmer {
        0% {
          transform: translateX(-100%);
        }

        50% {
          transform: translateX(100%);
        }

        100% {
          transform: translateX(200%);
        }
      }

      .progress-interactive {
        cursor: pointer;
      }

      .progress-interactive:hover .custom-progress-fill {
        box-shadow: 0 0 12px rgba(255, 107, 139, 0.6);
      }

      body {
        font-family: "Gugi", sans-serif;
      }

      /* Character and Sole Press Animation */
      .character-container {
        transition: transform 0.15s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        z-index: 50; /* Ensure character is above sole */
      }

      .character-container.pressed {
        transform: translateY(6px);
      }

      #sole {
        transition: transform 0.15s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        z-index: 10; /* Lower than character */
      }

      #sole.pressed {
        transform: translateY(8px);
      }

      /* Light Effect Animation */
      .light-effect {
        position: absolute;
        bottom: -160px;
        left: 50%;
        transform: translateX(-50%);
        width: 840px;
        height: 840px;
        background-image: url("./image/light.png");
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        opacity: 0;
        z-index: 1; /* Below everything else */
        pointer-events: none;
        transition: opacity 0.3s ease;
      }

      .light-effect.show {
        opacity: 1;
      }

      /* Coin Flying Animation */
      @keyframes coinFly {
        0% {
          transform: translate(0, 0) scale(0.8) rotate(0deg);
          opacity: 0;
        }
        10% {
          transform: translate(0, -30px) scale(1.8) rotate(45deg);
          opacity: 1;
        }
        50% {
          transform: translate(
              calc(var(--tx) * 0.5),
              calc(var(--ty) * 0.5 - 80px)
            )
            scale(1.5) rotate(180deg);
          opacity: 0.9;
        }
        80% {
          transform: translate(calc(var(--tx) * 0.8), calc(var(--ty) * 0.8))
            scale(1.2) rotate(270deg);
          opacity: 0.7;
        }
        100% {
          transform: translate(var(--tx), var(--ty)) scale(1) rotate(360deg);
          opacity: 0;
        }
      }

      .flying-coin {
        position: fixed;
        width: 35px;
        height: 35px;
        background: url("./image/money.svg") no-repeat center;
        background-size: contain;
        pointer-events: none;
        z-index: 9999;
        animation: coinFly 2.5s ease-out forwards;
      }

      /* Level Up Popup Styles */
      .level-up-popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }

      .level-up-popup.show {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
      }

      .level-up-content {
        background: linear-gradient(135deg, #2e032c 0%, #450832 100%);
        border: 2px solid rgba(215, 12, 163, 0.5);
        border-radius: 20px;
        padding: 30px;
        text-align: center;
        max-width: 300px;
        width: 90%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
      }

      .level-up-emoji {
        font-size: 48px;
        margin-bottom: 15px;
      }

      .level-up-title {
        font-size: 24px;
        font-weight: bold;
        color: #ff6b8b;
        margin-bottom: 10px;
      }

      .level-up-description {
        color: white;
        margin-bottom: 20px;
        font-size: 14px;
      }

      .level-up-button {
        background: linear-gradient(90deg, #ff6b8b 0%, #ff4081 100%);
        border: none;
        border-radius: 10px;
        padding: 12px 30px;
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      .level-up-button:hover {
        transform: scale(1.05);
      }

      /* Tap area styles */
      .tap-area {
        cursor: pointer;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
      }

      /* Flash effect for tap feedback */
      @keyframes flash {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
        100% {
          opacity: 1;
        }
      }

      .flash {
        animation: flash 0.2s ease-out;
      }

      /* Progress Bar Styles from index.html */
      .progress-bar {
        background: linear-gradient(90deg, #e45f90 0%, #f06292 100%);
        height: 8px;
      }

      .progress-icon {
        position: absolute;
        border-radius: 0.5px;
        background: linear-gradient(0deg, #bac1d6 0.01%, #ffffff 99.98%);
        width: 5.5px;
        height: 14px;
        top: -1px;
        transition: left 0.3s ease;
      }

      .level-bars {
        background-color: #16a34a;
        height: 12px;
      }

      /* HP Progress Container */
      .hp-progress-container {
        position: relative;
        width: 100%;
        height: 12px;
        background: rgba(215, 12, 163, 0.42);
        border-radius: 4px;
        overflow: hidden;
      }

      /* HP Level Progress Container */
      .hp-level-progress-container {
        position: relative;
        width: 100%;
        height: 12px;
        background: rgba(215, 12, 163, 0.42);
        border-radius: 4px;
        overflow: hidden;
      }

      /* LP Level Progress Container */
      .lp-level-progress-container {
        position: relative;
        width: 100%;
        height: 12px;
        background: rgba(215, 12, 163, 0.42);
        border-radius: 4px;
        overflow: hidden;
      }

      /* Level Progress Icon */
      .level-progress-icon {
        position: absolute;
        border-radius: 0.5px;
        background: linear-gradient(0deg, #bac1d6 0.01%, #ffffff 99.98%);
        width: 5.5px;
        height: 14px;
        top: -1px;
        transition: left 0.3s ease;
      }

      /* Mobile adjustments */
      @media screen and (max-width: 428px) {
        .level-bars {
          height: 8px;
        }

        .progress-icon {
          height: 12px;
        }

        .level-progress-icon {
          height: 12px;
        }
      }

      /* Auto Earn Button Styles */
      #auto-earn-button {
        transition: all 0.3s ease;
        cursor: pointer;
        z-index: 100;
        position: relative;
      }

      #auto-earn-button:hover {
        transform: scale(1.05);
        box-shadow: 0 0 15px rgba(255, 107, 139, 0.4);
      }

      #auto-earn-button.active {
        background: linear-gradient(
          135deg,
          #ff6b8b 0%,
          #ff4081 100%
        ) !important;
        border: 2px solid #ff6b8b !important;
        box-shadow: 0 0 20px rgba(255, 107, 139, 0.6),
          inset 0 0 10px rgba(255, 255, 255, 0.2) !important;
        animation: pulse-glow 2s infinite;
      }

      #auto-earn-button.active img {
        filter: brightness(1.2) drop-shadow(0 0 5px rgba(255, 255, 255, 0.8));
      }

      @keyframes pulse-glow {
        0% {
          box-shadow: 0 0 20px rgba(255, 107, 139, 0.6),
            inset 0 0 10px rgba(255, 255, 255, 0.2);
        }
        50% {
          box-shadow: 0 0 30px rgba(255, 107, 139, 0.8),
            inset 0 0 15px rgba(255, 255, 255, 0.3);
        }
        100% {
          box-shadow: 0 0 20px rgba(255, 107, 139, 0.6),
            inset 0 0 10px rgba(255, 255, 255, 0.2);
        }
      }
    </style>
  </head>

  <body class="bg-gray-900 min-h-screen">
    <div
      class="w-[375px] relative h-[667px] rounded-[20px] mx-auto gradient-bg p-[16px]"
    >
      <img
        class="absolute rounded-[20px] top-0 left-0 z-[-1] bottom-0 right-0"
        src="./image/bg.png"
        alt=""
      />
      <div class="flex flex-col gap-[8px]">
        <div class="flex justify-between items-center">
          <div
            class="flex w-[165.5px] h-[30px] px-[4px] pr-[12px] py-[4px] gap-[8px] rounded-full card-bg items-center"
          >
            <img src="./image/ruby.svg" alt="" />

            <span
              id="coin-count"
              class="gugi-font text-[14px] leading-[22px] tracking-[0%] align-middle text-white"
              >0</span
            >
          </div>

          <div
            class="flex w-[165.5px] h-[30px] px-[4px] pr-[12px] py-[4px] gap-[8px] rounded-full card-bg items-center"
          >
            <img src="./image/money.svg" alt="" />

            <span
              id="coin-earn"
              class="gugi-font text-[14px] leading-[22px] tracking-[0%] align-middle text-white"
              >0</span
            >
          </div>
        </div>

        <div
          class="card-bg gradient-bg p-[12px] rounded-[20px] w-full h-[142.5px]"
        >
          <div class="flex flex-col gap-[8px]">
            <div class="flex justify-between">
              <div class="flex flex-col gap-[10px] w-[228px]">
                <div class="flex justify-between">
                  <p
                    class="font-normal text-[13px] leading-[20px] tracking-[0%] text-center align-middle text-[#FF6B8B]"
                  >
                    HP
                  </p>
                  <p
                    id="hp-display"
                    class="font-normal text-[13px] leading-[20px] tracking-[0%] text-center align-middle text-white"
                  >
                    100/100
                  </p>
                </div>
                <!-- HP Progress Bar -->
                <div class="hp-progress-container">
                  <div
                    class="progress-bar"
                    id="hp-bar"
                    style="width: 100%; transition: width 0.3s ease-in-out"
                  ></div>
                  <div class="progress-icon" style="left: 100%"></div>
                </div>
              </div>
              <div
                class="w-[63px] h-[52px] bg-[rgba(252,55,102,0.13)] flex flex-col gap-[4px] items-center justify-center rounded-[8px]"
              >
                <img class="w-[16px] h-[16px]" src="./image/money.png" alt="" />
                <p
                  id="total-coins"
                  class="font-normal text-[13px] leading-[20px] tracking-[0%] text-center align-middle text-white"
                >
                  0
                </p>
              </div>
            </div>
            <img src="./image/divider.svg" alt="" />
            <div class="flex justify-between items-center">
              <div class="w-[143px] flex flex-col gap-[9px]">
                <div class="flex justify-between">
                  <p
                    class="font-normal text-[13px] leading-[20px] tracking-[0%] text-center align-middle text-[#FF6B8B]"
                  >
                    HP lv
                  </p>
                  <p
                    id="hp-level-display"
                    class="font-normal text-[13px] leading-[20px] tracking-[0%] text-center align-middle text-white"
                  >
                    1/100
                  </p>
                </div>

                <!-- HP Level Progress Bar -->
                <div class="hp-level-progress-container">
                  <div
                    class="level-bars"
                    id="hp-level-bar"
                    style="width: 0%; transition: width 0.3s ease-in-out"
                  ></div>
                  <div class="level-progress-icon" style="left: 0%"></div>
                </div>
              </div>

              <div class="w-[143px] flex flex-col gap-[9px]">
                <div class="flex justify-between">
                  <p
                    class="font-normal text-[13px] leading-[20px] tracking-[0%] text-center align-middle text-[#FF6B8B]"
                  >
                    MT lv
                  </p>
                  <p
                    id="lp-level-display"
                    class="font-normal text-[13px] leading-[20px] tracking-[0%] text-center align-middle text-white"
                  >
                    1/100
                  </p>
                </div>

                <!-- LP Level Progress Bar -->
                <div class="lp-level-progress-container">
                  <div
                    class="level-bars"
                    id="lp-level-bar"
                    style="width: 0%; transition: width 0.3s ease-in-out"
                  ></div>
                  <div class="level-progress-icon" style="left: 0%"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="w-full flex justify-end">
          <div
            class="card-bg gradient-bg w-[85px] py-[8px] px-[12px] flex flex-col gap-[8px] rounded-lg"
          >
            <p
              class="font-normal text-[13px] leading-[20px] tracking-[0%] text-center align-middle text-white"
            >
              Events
            </p>
            <img class="w-[61px] h-[61px]" src="./image/gift.png" alt="" />
          </div>
        </div>
      </div>
      <div class="absolute bottom-[-20px] left-[-12px] p-[10px]">
        <div class="relative flex flex-col justify-between items-center">
          <div
            class="absolute top-[-150px] left-[20px] right-0 flex justify-center character-container"
          >
            <img
              id="younghee"
              class="w-[149px] h-[224px] tap-area"
              src="./image/character.png"
              alt=""
            />
          </div>
          <div class="relative">
            <!-- Light effect element -->
            <div id="light-effect" class="light-effect"></div>
            <img id="sole" class="tap-area" src="./image/sole1.png" alt="" />
          </div>
        </div>
      </div>
      <div
        class="absolute bottom-[-20px] right-[16px] flex flex-col items-center justify-center"
      >
        <button
          id="auto-earn-button"
          class="gradient-bg card-bg w-[48px] h-[48px] rounded-lg flex items-center justify-center"
        >
          <img src="./image/button.svg" alt="" />
        </button>
        <p
          class="font-normal text-[13px] leading-[20px] tracking-[0%] text-center align-middle text-[#FF6B8B]"
        >
          Auto earn
        </p>
      </div>

      <div
        class="absolute bottom-[-110px] gradient-bg card-bg w-[343px] h-[64px] rounded-full p-[20px]"
      >
        <ul class="flex justify-between items-center gap-[16px]">
          <li class="w-[24px] h-[24px]">
            <img src="./image/cart.svg" alt="" />
          </li>
          <li class="w-[24px] h-[24px]">
            <img src="./image/refesh.svg" alt="" />
          </li>
          <li class="w-[24px] h-[24px]">
            <img src="./image/wallet.svg" alt="" />
          </li>
          <li class="w-[24px] h-[24px]">
            <img src="./image/star.svg" alt="" />
          </li>
          <li class="w-[24px] h-[24px]">
            <img src="./image/building.svg" alt="" />
          </li>
        </ul>
      </div>
    </div>

    <!-- Level Up Popup -->
    <div id="level-up-popup" class="level-up-popup">
      <div class="level-up-content">
        <div class="level-up-emoji">🎉</div>
        <div class="level-up-text-container">
          <div class="level-up-title">Level Up!</div>
          <div class="level-up-description">
            New rewards unlocked and stronger power await you.
          </div>
        </div>
        <button
          id="level-up-confirm-btn"
          class="level-up-button"
          onclick="closeLevelUpPopup()"
        >
          <span class="level-up-button-text">Confirm</span>
        </button>
      </div>
    </div>

    <script>
      // =====================
      // 1. Game Configuration - 100 Levels
      // =====================

      // Level up requirements (same as index.html)
      const LEVEL_UP_REQUIREMENTS = [
        3200,
        5200,
        7500,
        10100,
        13000,
        16200,
        19600,
        23300,
        27400,
        31700, // 1-10
        48400,
        55000,
        62000,
        69200,
        76800,
        84900,
        93400,
        102200,
        111400,
        121000, // 11-20
        163700,
        176700,
        190100,
        204000,
        218400,
        233300,
        248700,
        264500,
        280800,
        297600, // 21-30
        389700,
        423400,
        458200,
        494200,
        531400,
        569700,
        609200,
        649800,
        691500,
        734400, // 31-40
        908200,
        960900,
        1015100,
        1070500,
        1127300,
        1185400,
        1244900,
        1305700,
        1367900,
        0, // 41-49, 50 là ruby
        1710000,
        1881000,
        2052000,
        2223000,
        0, // 51-54, 55 là ruby
        2394000,
        2565000,
        2736000,
        2907000,
        0, // 56-59, 60 là ruby
        3420000,
        3762000,
        4104000,
        4446000,
        0, // 61-64, 65 là ruby
        5130000,
        5472000,
        5814000,
        6156000,
        0, // 66-69, 70 là ruby
        6498000,
        7147000,
        7797600,
        8447400,
        0, // 71-74, 75 là ruby
        9747000,
        10396800,
        11046600,
        11696400,
        0, // 76-79, 80 là ruby
        12346200,
        13580820,
        14815440,
        16050060,
        0, // 81-84, 85 là ruby
        18519300,
        19753920,
        20988540,
        22223160,
        0, // 86-89, 90 là ruby
        23457780,
        26976448,
        30495114,
        34013782,
        0, // 91-94, 95 là ruby
        41051116,
        44569782,
        48008450,
        0, // 96-98, 99 là ruby
      ];

      // Coin per tap by level
      const TAP_COIN_BY_LEVEL = [
        { from: 1, to: 10, value: 24 },
        { from: 11, to: 20, value: 27 },
        { from: 21, to: 30, value: 31 },
        { from: 31, to: 40, value: 35 },
        { from: 41, to: 49, value: 39 },
        { from: 50, to: 60, value: 47 },
        { from: 61, to: 70, value: 54 },
        { from: 71, to: 80, value: 61 },
        { from: 81, to: 90, value: 70 },
        { from: 91, to: 100, value: 80 },
      ];

      // =====================
      // 2. Game State Management
      // =====================

      function getLevelHP(level) {
        if (level <= 1) return 100;
        let hp = 100;
        for (let lv = 2; lv <= level; lv++) {
          if (lv <= 30) hp += 50;
          else if (lv <= 60) hp += 100;
          else if (lv <= 90) hp += 150;
          else hp += 200;
        }
        return hp;
      }

      function getTapCoin(level) {
        if (level <= 1) return 24;
        for (const range of TAP_COIN_BY_LEVEL) {
          if (level >= range.from && level <= range.to) return range.value;
        }
        return 24;
      }

      function getUpgradeMultiplier(level) {
        if (level <= 1) return 1;
        return 1 + (level - 1) * 0.05;
      }

      function getLevelUpRequirement(level) {
        return LEVEL_UP_REQUIREMENTS[level - 1] || 0;
      }

      function getTotalCoinsForLevel(level) {
        if (level <= 1) return 0;
        let total = 0;
        for (let i = 0; i < level - 1; i++) {
          total += LEVEL_UP_REQUIREMENTS[i] || 0;
        }
        return total;
      }

      function canLevelUp(currentLevel, totalCoins) {
        const currentLevelRequirement = getLevelUpRequirement(currentLevel);
        return (
          currentLevelRequirement > 0 &&
          totalCoins >= currentLevelRequirement &&
          currentLevel < 100
        );
      }

      function loadGameState() {
        const data = localStorage.getItem("game_interface_state");
        if (data) return JSON.parse(data);
        return {
          level: 1,
          hp: getLevelHP(1),
          coinEarn: 0,
          coinCount: 0,
          lastRecover: Date.now(),
          lastZeroHP: null,
        };
      }

      function saveGameState(state) {
        localStorage.setItem("game_interface_state", JSON.stringify(state));
      }

      // =====================
      // 3. UI Update Functions
      // =====================

      function updateUI(state) {
        const maxHP = getLevelHP(state.level);
        const hpPercentage = Math.max(
          0,
          Math.min(100, (state.hp / maxHP) * 100)
        );

        // Update HP display
        document.getElementById(
          "hp-display"
        ).textContent = `${state.hp}/${maxHP}`;
        document.getElementById("hp-bar").style.width = `${hpPercentage}%`;

        // Update HP progress icon position
        const hpProgressIcon = document.querySelector(
          ".hp-progress-container .progress-icon"
        );
        if (hpProgressIcon) {
          hpProgressIcon.style.left = `${hpPercentage}%`;
        }

        // Update coin displays
        // Ruby (coin-count) stays at 0 - not used
        // Money (coin-earn) shows final coinCount after HP=0
        // Total-coins box shows current coinEarn during tapping
        document.getElementById("coin-count").textContent = "0";
        document.getElementById("coin-earn").textContent = state.coinCount;
        document.getElementById("total-coins").textContent = state.coinEarn;

        // Update level displays
        document.getElementById(
          "hp-level-display"
        ).textContent = `${state.level}/100`;
        document.getElementById(
          "lp-level-display"
        ).textContent = `${state.level}/100`;

        // Calculate level progress based on level/100
        const levelProgress = Math.min(100, (state.level / 100) * 100);

        // Update level progress bars - fix the IDs
        const hpLevelBar = document.getElementById("hp-level-bar");
        const lpLevelBar = document.getElementById("lp-level-bar");

        if (hpLevelBar) {
          hpLevelBar.style.width = `${levelProgress}%`;
        }
        if (lpLevelBar) {
          lpLevelBar.style.width = `${levelProgress}%`;
        }

        // Update level progress icons
        const hpLevelIcon = document.querySelector(
          ".hp-level-progress-container .level-progress-icon"
        );
        const lpLevelIcon = document.querySelector(
          ".lp-level-progress-container .level-progress-icon"
        );

        if (hpLevelIcon) {
          hpLevelIcon.style.left = `${levelProgress}%`;
        }
        if (lpLevelIcon) {
          lpLevelIcon.style.left = `${levelProgress}%`;
        }
      }

      // =====================
      // 4. Flying Coin Animation
      // =====================

      function createFlyingCoin(startX, startY, targetElement) {
        const coin = document.createElement("div");
        coin.className = "flying-coin";
        coin.style.left = startX + "px";
        coin.style.top = startY + "px";

        const targetRect = targetElement.getBoundingClientRect();
        const targetX = targetRect.left + targetRect.width / 2;
        const targetY = targetRect.top + targetRect.height / 2;

        const deltaX = targetX - startX;
        const deltaY = targetY - startY;

        coin.style.setProperty("--tx", deltaX + "px");
        coin.style.setProperty("--ty", deltaY + "px");

        document.body.appendChild(coin);

        setTimeout(() => {
          if (coin.parentNode) {
            coin.parentNode.removeChild(coin);
          }
        }, 2500);
      }

      // =====================
      // 5. Character Animation Functions
      // =====================

      function createSparkles() {
        const sparkleContainer = document.createElement("div");
        sparkleContainer.style.cssText = `
          position: absolute;
          bottom: -50px;
          left: 50%;
          transform: translateX(-50%);
          width: 600px;
          height: 600px;
          pointer-events: none;
          z-index: 6;
        `;

        // Create multiple sparkle particles
        for (let i = 0; i < 12; i++) {
          const sparkle = document.createElement("div");
          const size = Math.random() * 8 + 4;
          const delay = Math.random() * 0.3;
          const duration = Math.random() * 0.8 + 0.6;
          const x = (Math.random() - 0.5) * 400;
          const y = (Math.random() - 0.5) * 400;

          sparkle.style.cssText = `
            position: absolute;
            width: ${size}px;
            height: ${size}px;
            background: radial-gradient(circle, #ffffff 0%, #ffeb3b 50%, transparent 100%);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: sparkleFloat ${duration}s ease-out ${delay}s forwards;
            opacity: 0;
          `;

          sparkle.style.setProperty("--x", x + "px");
          sparkle.style.setProperty("--y", y + "px");

          sparkleContainer.appendChild(sparkle);
        }

        // Add sparkle animation
        const style = document.createElement("style");
        style.textContent = `
          @keyframes sparkleFloat {
            0% {
              transform: translate(-50%, -50%) scale(0) rotate(0deg);
              opacity: 0;
            }
            20% {
              transform: translate(calc(-50% + var(--x) * 0.2), calc(-50% + var(--y) * 0.2)) scale(1) rotate(90deg);
              opacity: 1;
            }
            80% {
              transform: translate(calc(-50% + var(--x) * 0.8), calc(-50% + var(--y) * 0.8)) scale(0.8) rotate(270deg);
              opacity: 0.8;
            }
            100% {
              transform: translate(calc(-50% + var(--x)), calc(-50% + var(--y))) scale(0) rotate(360deg);
              opacity: 0;
            }
          }
        `;
        document.head.appendChild(style);

        return { container: sparkleContainer, style };
      }

      function triggerCharacterPress(isSpecial = false) {
        const characterContainer = document.querySelector(
          ".character-container"
        );
        const soleElement = document.getElementById("sole");
        const lightEffect = document.getElementById("light-effect");

        characterContainer.classList.add("pressed");
        soleElement.classList.add("pressed");

        // Show light effect (without pressed movement)
        if (lightEffect) {
          lightEffect.classList.add("show");
          if (isSpecial) {
            lightEffect.classList.add("special");
          }
        }

        // Create sparkles effect
        const sparkleData = createSparkles();
        const soleContainer = soleElement.parentElement;
        soleContainer.appendChild(sparkleData.container);

        setTimeout(
          () => {
            characterContainer.classList.remove("pressed");
            soleElement.classList.remove("pressed");

            // Hide light effect
            if (lightEffect) {
              lightEffect.classList.remove("show");
              if (isSpecial) {
                lightEffect.classList.remove("special");
              }
            }

            // Clean up sparkles
            setTimeout(() => {
              if (sparkleData.container.parentNode) {
                sparkleData.container.parentNode.removeChild(
                  sparkleData.container
                );
              }
              if (sparkleData.style.parentNode) {
                sparkleData.style.parentNode.removeChild(sparkleData.style);
              }
            }, 1000);
          },
          isSpecial ? 600 : 400
        );
      }

      // =====================
      // 6. Main Tap Function
      // =====================

      function tap(event, multiplier = 1) {
        console.log("Tap function called!", event, multiplier);
        let state = loadGameState();
        console.log("Current state:", state);

        if (state.hp <= 0) {
          console.log("Cannot tap - HP is 0");
          return;
        }

        // Check for 3-finger tap on touch devices
        let finalMultiplier = multiplier;
        let hpMultiplier = 1; // Separate multiplier for HP loss
        let is3FingerTap = false;

        if (event && event.touches && event.touches.length === 3) {
          finalMultiplier = multiplier * 3; // 3x coins for 3-finger tap
          hpMultiplier = 3; // 3x HP loss for 3-finger tap
          is3FingerTap = true;
          console.log(
            "3-finger tap detected! Coin multiplier:",
            finalMultiplier,
            "HP multiplier:",
            hpMultiplier
          );

          // Add special visual feedback for 3-finger tap
          triggerSpecial3FingerEffect();
        }

        // Create flying coin effect - target the total-coins box
        if (event) {
          const totalCoinsBox = document.querySelector(
            ".w-\\[63px\\].h-\\[52px\\]"
          );
          if (totalCoinsBox) {
            // Create multiple coins for 3-finger tap
            const coinCount = is3FingerTap ? 3 : 1;
            for (let i = 0; i < coinCount; i++) {
              setTimeout(() => {
                createFlyingCoin(
                  event.clientX ||
                    event.touches?.[0]?.clientX ||
                    window.innerWidth / 2,
                  event.clientY ||
                    event.touches?.[0]?.clientY ||
                    window.innerHeight / 2,
                  totalCoinsBox
                );
              }, i * 100); // Stagger the coins
            }
          }

          // Trigger character press animation
          if (!is3FingerTap) {
            triggerCharacterPress();
          }
        }

        // Decrease HP with proper calculation
        const oldHP = state.hp;
        const baseHPLoss = 4; // Base HP loss per tap
        const hpLoss = baseHPLoss * hpMultiplier; // Should be 4 for normal, 12 for 3-finger

        // Validate HP loss calculation
        const expectedHPLoss = is3FingerTap ? 12 : 4;
        if (hpLoss !== expectedHPLoss) {
          console.error(
            "HP loss calculation error! Expected:",
            expectedHPLoss,
            "Got:",
            hpLoss
          );
          // Force correct value
          const correctedHPLoss = expectedHPLoss;
          state.hp -= correctedHPLoss;
          console.log(
            "HP changed from",
            oldHP,
            "to",
            state.hp,
            "(-" + correctedHPLoss + " HP - CORRECTED)",
            is3FingerTap ? "(3-finger tap)" : "(normal tap)"
          );
        } else {
          state.hp -= hpLoss;
          console.log(
            "HP changed from",
            oldHP,
            "to",
            state.hp,
            "(-" + hpLoss + " HP)",
            is3FingerTap ? "(3-finger tap)" : "(normal tap)"
          );
        }

        // Calculate coins with proper multiplier
        let tapCoin;
        if (finalMultiplier === 0.25) {
          tapCoin = Math.floor(
            (getTapCoin(state.level) * getUpgradeMultiplier(state.level)) / 4
          );
        } else {
          // For 3-finger tap: base coin * upgrade multiplier * 3
          // For normal tap: base coin * upgrade multiplier * 1
          const baseCoin =
            getTapCoin(state.level) * getUpgradeMultiplier(state.level);
          if (is3FingerTap) {
            tapCoin = Math.round(baseCoin * 3); // Exactly 3x for 3-finger tap
          } else {
            tapCoin = Math.round(baseCoin * finalMultiplier);
          }
        }

        // Add coins to coinEarn (which shows in total-coins box during tapping)
        state.coinEarn += tapCoin;
        console.log("Coin earned:", tapCoin, "Total coinEarn:", state.coinEarn);

        // Handle HP reaching 0
        if (state.hp <= 0) {
          state.hp = 0;
          // Transfer coins from coinEarn to coinCount (top display)
          state.coinCount += state.coinEarn;
          state.coinEarn = 0;
          state.lastRecover = Date.now();
          state.lastZeroHP = Date.now();

          saveGameState(state);
          updateUI(state);

          // Check for level up after delay
          setTimeout(() => {
            let currentState = loadGameState();
            if (canLevelUp(currentState.level, currentState.coinCount)) {
              currentState.level++;
              if (currentState.hp > 0) {
                currentState.hp = getLevelHP(currentState.level);
              }
              saveGameState(currentState);
              updateUI(currentState);
              showLevelUpPopup(currentState.level);
            }
          }, 500);

          return;
        }

        // Check for level up (when HP > 0)
        if (canLevelUp(state.level, state.coinCount)) {
          const oldLevel = state.level;
          state.level++;
          if (state.hp > 0) {
            state.hp = getLevelHP(state.level);
          }
          showLevelUpPopup(state.level);
        }

        saveGameState(state);
        updateUI(state);
        console.log("Tap completed, state saved");
      }

      // =====================
      // 6.1. Special 3-Finger Effect
      // =====================

      function triggerSpecial3FingerEffect() {
        // Add special glow effect to character
        const character = document.getElementById("younghee");
        const sole = document.getElementById("sole");

        if (character && sole) {
          character.style.filter =
            "drop-shadow(0 0 20px #FFD700) brightness(1.3)";
          sole.style.filter = "drop-shadow(0 0 15px #FFD700) brightness(1.2)";

          // Remove effect after animation
          setTimeout(() => {
            character.style.filter = "";
            sole.style.filter = "";
          }, 500);
        }

        // Show 3x multiplier text
        show3xMultiplierText();

        // Trigger special character press with light effect
        triggerCharacterPress(true);
      }

      function show3xMultiplierText() {
        // Create floating 3x text
        const multiplierText = document.createElement("div");
        multiplierText.textContent = "3X COINS!";
        multiplierText.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          font-size: 24px;
          font-weight: bold;
          color: #FFD700;
          text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
          z-index: 9999;
          pointer-events: none;
          animation: bounce3x 1s ease-out forwards;
        `;

        // Add bounce animation
        const style = document.createElement("style");
        style.textContent = `
          @keyframes bounce3x {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1) translateY(-30px); opacity: 0; }
          }
        `;
        document.head.appendChild(style);
        document.body.appendChild(multiplierText);

        // Remove after animation
        setTimeout(() => {
          if (multiplierText.parentNode) {
            multiplierText.parentNode.removeChild(multiplierText);
          }
          if (style.parentNode) {
            style.parentNode.removeChild(style);
          }
        }, 1000);
      }

      // =====================
      // 7. HP Recovery Function
      // =====================

      function recoverHP() {
        let state = loadGameState();

        // Only 3-minute 2% HP recovery logic
        const currentTime = Date.now();
        if (!state.lastRecover) {
          state.lastRecover = currentTime;
        }

        const timeSinceLastRecover = currentTime - state.lastRecover;
        if (timeSinceLastRecover >= 3 * 60 * 1000) {
          // 3 minutes
          const maxHP = getLevelHP(state.level);
          const recoveryAmount = Math.floor(maxHP * 0.02); // 2% of max HP

          // Recover 2% regardless of current HP amount, but don't exceed max HP
          if (state.hp < maxHP) {
            state.hp = Math.min(maxHP, state.hp + recoveryAmount);
            state.lastRecover = currentTime;
            saveGameState(state);
            updateUI(state);
          }
        }
      }

      // =====================
      // 8. Level Up Popup Functions
      // =====================

      function showLevelUpPopup(newLevel) {
        const popup = document.getElementById("level-up-popup");
        const titleElement = popup.querySelector(".level-up-title");

        if (titleElement) {
          titleElement.textContent = `Level ${newLevel}!`;
        }

        popup.style.display = "flex";
        popup.classList.add("show");
      }

      function closeLevelUpPopup() {
        const popup = document.getElementById("level-up-popup");
        popup.classList.remove("show");
        setTimeout(() => {
          popup.style.display = "none";
        }, 300);
      }

      // =====================
      // 9. Auto Earn Function
      // =====================

      let isAutoEarnEnabled = false;
      let autoEarnInterval = null;

      function toggleAutoEarn() {
        const button = document.getElementById("auto-earn-button");

        if (isAutoEarnEnabled) {
          // Disable auto earn
          isAutoEarnEnabled = false;
          if (autoEarnInterval) {
            clearInterval(autoEarnInterval);
            autoEarnInterval = null;
          }
          button.classList.remove("active");
        } else {
          // Enable auto earn
          isAutoEarnEnabled = true;
          autoEarnInterval = setInterval(() => {
            if (isAutoEarnEnabled) {
              const fakeEvent = {
                clientX: window.innerWidth / 2,
                clientY: window.innerHeight / 2,
              };
              tap(fakeEvent, 0.25);
            }
          }, 1000);
          button.classList.add("active");
        }
      }

      // =====================
      // 10. Event Listeners
      // =====================

      // Add debounce mechanism to prevent multiple taps
      let lastTapTime = 0;
      const TAP_DEBOUNCE_MS = 100; // 100ms debounce

      function debouncedTap(event, multiplier = 1) {
        const currentTime = Date.now();
        if (currentTime - lastTapTime < TAP_DEBOUNCE_MS) {
          console.log("Tap ignored due to debounce");
          return;
        }
        lastTapTime = currentTime;
        tap(event, multiplier);
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Initialize game
        let initialState = loadGameState();
        updateUI(initialState);

        // Add tap event listeners for the main container only
        const mainContainer = document.querySelector(".w-\\[375px\\]");
        if (mainContainer) {
          // Handle click events
          mainContainer.addEventListener("click", function (event) {
            // Don't tap if clicking on buttons or UI elements
            if (
              event.target.closest("#auto-earn-button") ||
              event.target.closest(".level-up-popup") ||
              event.target.closest("button")
            ) {
              return;
            }
            event.preventDefault();
            event.stopPropagation();
            debouncedTap(event);
          });

          // Handle touch events (for mobile)
          mainContainer.addEventListener("touchstart", function (event) {
            // Don't tap if touching buttons or UI elements
            if (
              event.target.closest("#auto-earn-button") ||
              event.target.closest(".level-up-popup") ||
              event.target.closest("button")
            ) {
              return;
            }
            event.preventDefault();
            event.stopPropagation();
            debouncedTap(event);
          });

          // Prevent default touch behaviors that might interfere
          mainContainer.addEventListener("touchend", function (event) {
            event.preventDefault();
          });

          mainContainer.addEventListener("touchmove", function (event) {
            event.preventDefault();
          });
        }

        // Auto earn button
        document
          .getElementById("auto-earn-button")
          .addEventListener("click", function (event) {
            event.preventDefault();
            event.stopPropagation();
            toggleAutoEarn();
          });

        // Auto earn button touch support
        document
          .getElementById("auto-earn-button")
          .addEventListener("touchstart", function (event) {
            event.preventDefault();
            event.stopPropagation();
            toggleAutoEarn();
          });

        // Prevent auto earn button from being affected by main container events
        document
          .getElementById("auto-earn-button")
          .addEventListener("touchend", function (event) {
            event.preventDefault();
            event.stopPropagation();
          });

        document
          .getElementById("auto-earn-button")
          .addEventListener("touchmove", function (event) {
            event.preventDefault();
            event.stopPropagation();
          });

        // HP recovery interval
        setInterval(recoverHP, 60 * 1000); // Every minute

        console.log("Game Interface Initialized");
      });

      // Close popup when clicking outside
      document
        .getElementById("level-up-popup")
        .addEventListener("click", function (event) {
          if (event.target === this) {
            closeLevelUpPopup();
          }
        });
    </script>
  </body>
</html>
